<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××ª×’×¨ ×”××”× ×“×¡: ×©×‘×¨×™× ×•××™×œ×™× â›ï¸</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- ×¤×•× ×˜×™× --- */
        @font-face {
            font-family: 'Minecraft';
            src: url('https://raw.githubusercontent.com/TiagoVignatti/Minecraft-Font/master/minecraft_font.ttf') format('truetype');
        }

        /* --- Global Reset & Body --- */
        body {
            font-family: 'Minecraft', 'Courier New', monospace; 
            margin: 0;
            padding: 0;
            color: #FFF; 
            direction: rtl;
            text-align: right;
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
            display: flex;
            align-items: center;
            justify-content: center;
            image-rendering: pixelated;
            background-color: #87CEEB; 
        }

        /* --- 3D WORLD BACKGROUND --- */
        #world-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            perspective: 600px;
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #C8EAFF 60%, #E0F7FA 100%);
        }

        .sun {
            position: absolute;
            top: 10%; left: 10%; width: 80px; height: 80px;
            background-color: #FFF500;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            z-index: 1;
            animation: sunFloat 10s ease-in-out infinite alternate;
        }

        .cloud {
            position: absolute;
            background-color: rgba(255,255,255,0.8);
            width: 120px; height: 40px;
            z-index: 2;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.05);
            animation: moveCloud linear infinite;
        }
        .cloud::after {
            content: ''; position: absolute; top: -20px; left: 20px;
            width: 80px; height: 20px; background-color: rgba(255,255,255,0.8);
        }

        .ground-plane {
            position: absolute;
            bottom: -200px; left: -50%; width: 200%; height: 100%;
            background-color: #5C9338;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 2px, transparent 2px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 2px, transparent 2px);
            background-size: 60px 60px;
            transform: rotateX(60deg) translateZ(-50px);
            transform-origin: 50% 100%;
            z-index: 3;
            animation: moveGround 4s linear infinite;
            box-shadow: inset 0 100px 100px rgba(135, 206, 235, 0.5);
        }

        @keyframes moveGround { 0% { background-position: 0 0; } 100% { background-position: 0 60px; } }
        @keyframes moveCloud { 0% { transform: translateX(110vw); } 100% { transform: translateX(-20vw); } }
        @keyframes sunFloat { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }

        /* --- CINEMATIC INTRO STYLES --- */
        #cinematic-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        
        .lightning-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #FFF; opacity: 0; pointer-events: none;
        }

        /* Enderman Run Animation */
        .intro-enderman {
            position: relative; width: 120px; height: 200px;
            transform-origin: center bottom;
            animation: runToCamera 3s ease-in forwards;
        }
        
        @keyframes runToCamera {
            0% { transform: scale(0.2) translateY(50px); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: scale(8) translateY(20px); } /* Zoom in massively */
        }

        @keyframes flashLightning {
            0%, 10%, 25%, 100% { opacity: 0; }
            5%, 20% { opacity: 0.8; } /* Flash bursts */
            15% { opacity: 0.3; }
        }

        @keyframes aggressiveShake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }

        .anim-running .arm-l { animation: runArm 0.3s infinite alternate !important; }
        .anim-running .arm-r { animation: runArm 0.3s infinite alternate-reverse !important; }
        .anim-running .leg-l { animation: runLeg 0.3s infinite alternate !important; }
        .anim-running .leg-r { animation: runLeg 0.3s infinite alternate-reverse !important; }
        .anim-running .ender-head { animation: aggressiveShake 0.5s infinite !important; }

        @keyframes runArm { from { transform: rotate(45deg); } to { transform: rotate(-45deg); } }
        @keyframes runLeg { from { transform: translateY(-5px); } to { transform: translateY(5px); } }


        /* --- UI Overlay --- */
        .ui-layer {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; pointer-events: none;
        }

        /* --- GUI Styles --- */
        .mc-gui-container {
            pointer-events: auto;
            background-color: rgba(198, 198, 198, 0.95);
            border: 4px solid #000;
            box-shadow: inset 4px 4px 0 #FFF, inset -4px -4px 0 #555, 0 20px 50px rgba(0,0,0,0.5);
            padding: 12px;
            color: #3F3F3F; 
            width: 100%; max-width: 900px; max-height: 90vh;
            overflow-y: auto; position: relative;
        }

        .mc-slot {
            background-color: #8B8B8B;
            border-right: 2px solid #FFF; border-bottom: 2px solid #FFF;
            border-left: 2px solid #373737; border-top: 2px solid #373737;
            padding: 10px; display: flex; align-items: center; justify-content: center;
            box-shadow: inset 2px 2px 0 #000;
        }

        .btn-mc {
            border: 2px solid #000;
            box-shadow: inset 2px 2px 0 rgba(255,255,255,0.4), inset -2px -2px 0 rgba(0,0,0,0.4);
            color: #FFF; text-shadow: 2px 2px 0 #000; font-weight: bold;
            padding: 10px 20px; cursor: pointer; text-align: center;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-mc:active { transform: translateY(2px); box-shadow: inset 2px 2px 0 rgba(0,0,0,0.4); }
        .btn-mc:disabled { background-color: #555 !important; color: #888; cursor: not-allowed; filter: grayscale(100%); }

        .btn-stone { background-color: #757575; color: #FFF; }
        .btn-grass { background-color: #4A8F28; }
        .btn-diamond { background-color: #3C8DAB; }
        .btn-gold { background-color: #F0A804; color: #000; text-shadow: none; }
        .btn-redstone { background-color: #AA0000; }
        .btn-obsidian { background-color: #141019; border-color: #633196; }
        .btn-wood { background-color: #8F6942; }
        .btn-command { background-color: #C77E4F; border-color: #965F37; } 

        .mc-input {
            background-color: #222; color: #FFF; border: 2px solid #555;
            padding: 8px; font-family: inherit; text-align: center; font-size: 1.5rem;
            box-shadow: inset 2px 2px 0 #000;
        }
        .mc-input:focus { border-color: #FFF; background-color: #000; outline: none; }

        .question-box {
            background-color: #4A4A4A; border: 3px solid #222; padding: 15px;
            margin-bottom: 20px; color: #FFF; text-align: center; font-size: 1.3rem;
            text-shadow: 2px 2px 0 #000; box-shadow: inset 0 0 10px #000;
        }

        /* Thematic Elements */
        .grid-bar { display: flex; height: 40px; border: 3px solid #000; background: #333; margin-top: 1rem; }
        .grid-cell { flex: 1; border-left: 1px solid rgba(0,0,0,0.5); position: relative; }
        .grid-cell:first-child { border-left: none; }
        
        .theme-grass { background-color: #4A8F28; box-shadow: inset 0 3px 0 #6ABD45; }
        .theme-dirt { background-color: #866043; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        .theme-stone { background-color: #7D7D7D; box-shadow: inset 0 0 5px #555; }
        .theme-diamond { background-color: #3C8DAB; box-shadow: inset 2px 2px 5px #8CF4E2; border: 1px solid #285E73; }
        .theme-gold { background-color: #F0A804; box-shadow: inset 2px 2px 0 #FFFFAA; }
        .theme-iron { background-color: #E6E6E6; box-shadow: inset -2px -2px 5px #999; }
        .theme-tnt { background: repeating-linear-gradient(45deg, #DB2E23, #DB2E23 10px, #FFF 10px, #FFF 20px); border: 1px solid #000; }
        .theme-wood { background-color: #8F6942; border: 1px solid #5C4033; background-image: linear-gradient(0deg, rgba(0,0,0,0.1) 50%, transparent 50%); background-size: 4px 4px;}
        .empty-cell { background-color: #222; opacity: 0.5; }

        /* Enderman Base Styles */
        .enderman-scene { position: relative; width: 120px; height: 200px; margin: 0 auto 20px; }
        .ender-head { width: 40px; height: 35px; background: #000; position: absolute; top: 0; left: 40px; z-index: 10; animation: floatHead 4s ease-in-out infinite; }
        .ender-eye { width: 10px; height: 4px; background: #D57DFF; position: absolute; top: 18px; box-shadow: 0 0 5px #D57DFF; }
        .eye-l { left: 4px; } .eye-r { right: 4px; }
        .ender-body { width: 26px; height: 70px; background: #000; position: absolute; top: 35px; left: 47px; z-index: 5; }
        .ender-arm { width: 6px; height: 110px; background: #000; position: absolute; top: 38px; transform-origin: top center; }
        .arm-l { left: 38px; transform: rotate(3deg); animation: swayArm 3s infinite alternate; }
        .arm-r { right: 38px; transform: rotate(-3deg); animation: swayArm 3s infinite alternate-reverse; }
        .ender-leg { width: 6px; height: 100px; background: #000; position: absolute; top: 100px; }
        .leg-l { left: 48px; } .leg-r { right: 48px; }
        .particle { width: 6px; height: 6px; background: #D57DFF; position: absolute; opacity: 0; animation: portal 2s infinite; }
        
        @keyframes floatHead { 0%,100%{top:0;} 50%{top:-3px;} }
        @keyframes swayArm { 0%{transform:rotate(3deg);} 100%{transform:rotate(-3deg);} }
        @keyframes portal { 0% {transform:translate(0,0) scale(1); opacity:1;} 100% {transform:translate(var(--tx), var(--ty)) scale(0); opacity:0;} }

        .hidden { display: none !important; }
        .fraction-divider { height: 4px; background: #FFF; margin: 5px 0; box-shadow: 1px 1px 0 #000; }
    </style>
</head>
<body>

    <!-- Sounds -->
    <audio id="bg-music" loop>
        <source src="https://upload.wikimedia.org/wikipedia/commons/c/c4/Gymnopedie_No_1.ogg" type="audio/ogg">
    </audio>
    <audio id="sfx-thunder" preload="auto">
        <source src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Thunder_sound_effect.ogg" type="audio/ogg">
    </audio>

    <!-- CINEMATIC INTRO OVERLAY -->
    <div id="cinematic-overlay" class="z-[100]">
        <div id="start-btn-container" class="absolute z-50 text-center">
            <h1 class="text-6xl text-white mb-8 font-bold" style="text-shadow: 4px 4px #AA0000;">âš ï¸ ××–×”×¨×”</h1>
            <button onclick="playIntro()" class="btn-mc btn-obsidian text-3xl p-8 border-purple-500 animate-pulse">
                ×œ×—×¥ ×œ×”×¤×¢×œ×ª ×”××¢×¨×›×ª
            </button>
        </div>
        
        <div id="intro-animation" class="hidden w-full h-full relative flex items-center justify-center">
            <div class="lightning-flash"></div>
            
            <!-- Custom Enderman for Intro -->
            <div class="intro-enderman anim-running">
                <div class="ender-head"><div class="ender-eye eye-l" style="background:#FFF; box-shadow:0 0 10px #FFF"></div><div class="ender-eye eye-r" style="background:#FFF; box-shadow:0 0 10px #FFF"></div></div>
                <div class="ender-body"></div>
                <div class="ender-arm arm-l"></div><div class="ender-arm arm-r"></div>
                <div class="ender-leg leg-l"></div><div class="ender-leg leg-r"></div>
            </div>
        </div>
    </div>

    <!-- 3D WORLD LAYER -->
    <div id="world-layer">
        <div class="sun"></div>
        <div class="cloud" style="top: 15%; left: -20%; animation-duration: 25s;"></div>
        <div class="cloud" style="top: 25%; left: -40%; animation-duration: 35s; transform: scale(0.8);"></div>
        <div class="cloud" style="top: 10%; left: -10%; animation-duration: 45s; transform: scale(1.2);"></div>
        <div class="ground-plane"></div>
    </div>

    <!-- UI LAYER -->
    <div class="ui-layer">
        <div class="mc-gui-container hidden" id="main-interface">
            
            <!-- Top Bar -->
            <div class="flex flex-wrap justify-between items-center mb-4 border-b-2 border-gray-500 pb-2 gap-2">
                <div class="flex gap-2">
                    <button onclick="showHome()" class="btn-mc btn-redstone" title="×—×–×¨×” ×œ××¡×š ×”×¨××©×™">ğŸ  ×‘×™×ª</button>
                    <button onclick="showAdminPanel()" class="btn-mc btn-command text-black" title="×”×¢×œ××ª ×©××œ×•×ª">ğŸ–¥ï¸ Uploader</button>
                    <button id="music-btn" onclick="toggleMusic()" class="btn-mc btn-stone">ğŸµ × ×’×Ÿ</button>
                </div>
                
                <div class="flex gap-4 bg-gray-800 px-4 py-2 border-2 border-white rounded text-white">
                    <span>â­ × ×™×§×•×“: <span id="score-display" class="text-yellow-400">0</span></span>
                    <span>ğŸ’ ×™×”×œ×•××™×: <span id="diamonds-display" class="text-cyan-400">0</span></span>
                </div>
                
                <div>
                     <select id="difficulty-select" class="mc-input text-sm p-1" onchange="changeDifficulty()">
                        <option value="easy">ğŸŒ² ×§×œ</option>
                        <option value="medium" selected>â›ï¸ ×‘×™× ×•× ×™</option>
                        <option value="hard">ğŸ—¡ï¸ ×§×©×”</option>
                    </select>
                </div>
            </div>

            <!-- VIEWS -->

            <!-- 0. Intro View (Menu) -->
            <div id="intro-view" class="view flex flex-col items-center justify-center py-10">
                <div class="enderman-scene">
                    <div class="ender-head"><div class="ender-eye eye-l"></div><div class="ender-eye eye-r"></div></div>
                    <div class="ender-body"></div>
                    <div class="ender-arm arm-l"></div><div class="ender-arm arm-r"></div>
                    <div class="ender-leg leg-l"></div><div class="ender-leg leg-r"></div>
                    <div class="particle" style="top:50%; left:20%; --tx: -20px; --ty: -20px;"></div>
                    <div class="particle" style="top:30%; right:20%; --tx: 20px; --ty: -30px; animation-delay: 0.5s;"></div>
                </div>

                <h1 class="text-4xl font-bold mb-8 text-purple-800" style="text-shadow: 2px 2px #FFF;">×”××ª×’×¨ ×©×œ ×”×× ×“×¨××Ÿ</h1>
                <p class="mb-6 text-gray-700 font-bold">×”×©×œ× ××ª ×”××©×™××•×ª ×›×“×™ ×œ×‘× ×•×ª ×¤×•×¨×˜×œ!</p>
                <button onclick="startGame()" class="btn-mc btn-grass text-2xl px-12 py-4 shadow-lg">×”×ª×—×œ ××©×—×§ â–¶</button>
            </div>

            <!-- 1. Subject Menu -->
            <div id="subject-menu-view" class="view hidden text-center">
                <h2 class="text-2xl mb-8 text-gray-800">×‘×—×¨ ××ª ×”××›×¨×” ×©×œ×š:</h2>
                <div class="flex flex-col sm:flex-row justify-center gap-6">
                    <button onclick="showView('math-menu-view')" class="btn-mc btn-wood text-xl p-8 w-64 flex flex-col items-center gap-2">
                        <span class="text-4xl">ğŸ”¢</span>
                        <span>×¢×•×œ× ×”×©×‘×¨×™×</span>
                    </button>
                    <button onclick="showView('english-menu-view')" class="btn-mc btn-diamond text-xl p-8 w-64 flex flex-col items-center gap-2 text-black" style="text-shadow:none">
                        <span class="text-4xl">ğŸ“œ</span>
                        <span>×¢×•×œ× ×”××™×œ×™×</span>
                    </button>
                </div>
                <div class="mt-8">
                    <button onclick="showTips()" class="btn-mc btn-obsidian text-purple-300 border-purple-500">ğŸ’¡ ×¡×¤×¨ ×”×›×©×¤×™× (×˜×™×¤×™×)</button>
                </div>
            </div>

            <!-- 2. Math Menu -->
            <div id="math-menu-view" class="view hidden">
                <h2 class="text-2xl mb-4 text-center text-gray-800">××©×™××•×ª ×›×¨×™×™×” (×—×©×‘×•×Ÿ):</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button onclick="startMission(1)" class="btn-mc btn-stone text-lg text-right px-4">1. ğŸŒ² ××œ××™ ×”×ª×™×‘×” (×–×™×”×•×™)</button>
                    <button onclick="startMission(2)" class="btn-mc btn-stone text-lg text-right px-4">2. ğŸ—¿ ××™×•×Ÿ ×‘×œ×•×§×™× (×¡×•×’×™×)</button>
                    <button onclick="startMission(3)" class="btn-mc btn-stone text-lg text-right px-4">3. ğŸ§± ×©×•×œ×—×Ÿ ×”×™×¦×™×¨×” (×—×™×‘×•×¨)</button>
                    <button onclick="startMission(4)" class="btn-mc btn-stone text-lg text-right px-4">4. âš–ï¸ ×××–× ×™ ×”×›×•×— (×”×©×•×•××”)</button>
                    <button onclick="startMission(5)" class="btn-mc btn-gold text-lg text-right px-4">5. ğŸ² ×”×›×¤×¨ ×•×”××©×§ (××™×œ×•×œ×™×•×ª)</button>
                </div>
                <div class="text-center mt-6">
                    <button onclick="showView('subject-menu-view')" class="btn-mc btn-red">×—×–×¨×” ×œ×œ×•×‘×™</button>
                </div>
            </div>

            <!-- 3. English Menu -->
            <div id="english-menu-view" class="view hidden">
                <h2 class="text-2xl mb-4 text-center text-gray-800">××©×™××•×ª ×©×¤×” (×× ×’×œ×™×ª):</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button onclick="startMission(101)" class="btn-mc btn-stone text-lg text-right px-4">E1. ğŸ·ï¸ Inventory Sort (Vocab)</button>
                    <button onclick="startMission(102)" class="btn-mc btn-stone text-lg text-right px-4">E2. âœ… Steve's Actions (To Be)</button>
                    <button onclick="startMission(103)" class="btn-mc btn-stone text-lg text-right px-4">E3. ğŸ§­ Steve's Journal (Reading)</button>
                </div>
                <div class="text-center mt-6">
                    <button onclick="showView('subject-menu-view')" class="btn-mc btn-red">×—×–×¨×” ×œ×œ×•×‘×™</button>
                </div>
            </div>

            <!-- 4. Game Arena -->
            <div id="game-view" class="view hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="mission-title" class="text-xl font-bold text-gray-700">××©×™××”</h3>
                    <span class="text-gray-600 font-bold">×©××œ×” <span id="q-num">1</span></span>
                </div>

                <div class="question-box">
                    <p id="question-text">×”×©××œ×” ×ª×•×¤×™×¢ ×›××Ÿ...</p>
                </div>

                <div id="game-content" class="mb-6 min-h-[150px] flex flex-col items-center justify-center gap-4">
                    <!-- Dynamic Content -->
                </div>

                <div class="flex justify-center gap-4 flex-wrap mt-4">
                    <button onclick="prevQ()" class="btn-mc btn-stone">â¬…ï¸ ×”×§×•×“×</button>
                    <button onclick="checkAnswer()" id="check-btn" class="btn-mc btn-grass text-xl px-8">×‘×“×•×§! â›ï¸</button>
                    <button onclick="skipQ()" id="skip-btn" class="btn-mc btn-gold">×“×œ×’ â©</button>
                </div>

                <div id="feedback" class="hidden mt-4 p-4 border-2 border-white text-center font-bold text-xl" style="background:#333;"></div>
                
                 <div class="text-center mt-6">
                    <button onclick="showView('subject-menu-view')" class="btn-mc btn-red text-sm">×—×–×¨×” ×œ×œ×•×‘×™ (×‘×™×˜×•×œ ××©×™××”)</button>
                </div>
            </div>

            <!-- 5. Summary -->
            <div id="summary-view" class="view hidden text-center p-8">
                <h2 class="text-4xl mb-6 text-green-600" style="text-shadow: 2px 2px #FFF">×¡×™×•× ×›×¨×™×™×”!</h2>
                <div class="bg-gray-300 border-4 border-black p-6 mb-6 inline-block">
                    <p class="text-2xl text-black">× ×™×§×•×“ ×¡×•×¤×™: <span id="final-score">0</span></p>
                    <p class="text-2xl text-black">×™×”×œ×•××™×: <span id="final-diamonds">0</span> ğŸ’</p>
                </div>
                
                <div id="retake-section" class="hidden mb-6">
                    <p class="text-red-600 font-bold mb-2 text-xl">× ××¦××• ×¤×¨×™×˜×™× ×¤×’×•××™× (×˜×¢×•×™×•×ª)!</p>
                    <button onclick="startReview()" class="btn-mc btn-obsidian text-purple-300 border-purple-500 w-full py-4 text-xl animate-pulse">
                        â™»ï¸ ××‘×—×Ÿ ×—×•×–×¨ (×ª×§×Ÿ ×˜×¢×•×™×•×ª)
                    </button>
                </div>

                <div class="text-right mb-6">
                    <h3 class="text-xl mb-2 text-gray-700">×™×•××Ÿ ×—×¤×™×¨×•×ª (×˜×¢×•×™×•×ª):</h3>
                    <div class="bg-gray-800 border-2 border-white p-2 h-48 overflow-y-auto">
                        <table class="w-full text-sm text-white">
                            <thead><tr class="border-b border-gray-600"><th>×©××œ×”</th><th>×ª×©×•×‘×” × ×›×•× ×”</th></tr></thead>
                            <tbody id="error-log-body"></tbody>
                        </table>
                        <p id="no-errors-text" class="hidden text-center text-green-400 mt-4 font-bold text-lg">×¢×‘×•×“×” ××•×©×œ××ª! ××™×Ÿ ×ª×§×œ×•×ª ×‘××›×¨×”.</p>
                    </div>
                </div>
                
                <button onclick="showHome()" class="btn-mc btn-wood w-full py-3">×—×–×¨×” ×œ××—× ×” ğŸ </button>
            </div>

        </div>
    </div>

    <!-- Tips Modal -->
    <div id="tips-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-300 border-4 border-black p-6 max-w-md w-full relative text-black">
            <button onclick="hideTips()" class="absolute top-2 left-2 font-bold text-red-600 text-xl">X</button>
            <h3 class="text-2xl font-bold text-center mb-4">××“×¨×™×š ×”×”×™×©×¨×“×•×ª</h3>
            <ul class="list-disc pr-6 space-y-2 text-lg">
                <li><strong>×¡×‘×œ× ×•×ª:</strong> ×§×¨× ××ª ×”×©××œ×•×ª ×‘×–×”×™×¨×•×ª.</li>
                <li><strong>×× ×’×œ×™×ª:</strong> ×”×©×ª××© ×‘×¨××–×™× ××”×˜×§×¡×˜.</li>
                <li><strong>×©×‘×¨×™×:</strong> ×”××›× ×” ×”×•× ×¡×š ×”×‘×œ×•×§×™×.</li>
            </ul>
        </div>
    </div>

    <!-- Admin / Uploader Modal -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-orange-200 border-4 border-orange-900 p-6 max-w-2xl w-full relative text-black h-[550px] flex flex-col font-mono" style="background-color: #C77E4F; border-color: #5C3A21;">
            <button onclick="hideAdminPanel()" class="absolute top-2 left-2 font-bold text-red-900 text-xl">X</button>
            
            <div class="flex items-center justify-center gap-3 mb-4">
                <span class="text-4xl">ğŸ–¥ï¸</span>
                <h3 class="text-2xl font-bold text-center text-white drop-shadow-md">Command Block: Uploader</h3>
            </div>
            
            <p class="text-sm text-center mb-4 text-white font-bold bg-black bg-opacity-20 p-2 rounded">
                ×”×›× ×¡ ×¤×§×•×“×•×ª JSON ×›×“×™ ×œ×˜×¢×•×Ÿ ×©××œ×•×ª ×—×“×©×•×ª ×œ×¢×•×œ×.
            </p>
            
            <textarea id="json-input" class="flex-grow p-4 font-mono text-sm border-4 border-orange-800 bg-black text-green-400 mb-4 rounded shadow-inner" 
            placeholder='[
  { 
    "missionId": 1, 
    "q": "×©××œ×” ×—×“×©×”...", 
    "n": 1, "d": 2, 
    "type": "M_ID", 
    "theme": "diamond" 
  }
]'></textarea>
            
            <div class="flex gap-4">
                <button onclick="loadCustomQuestions()" class="btn-mc btn-green flex-1 shadow-lg">Load Data (×˜×¢×Ÿ)</button>
                <button onclick="clearCustomQuestions()" class="btn-mc btn-red flex-1 shadow-lg">Reset World (× ×§×”)</button>
            </div>
            <p id="admin-feedback" class="text-center mt-2 font-bold text-white"></p>
        </div>
    </div>

    <script>
        // --- Global State ---
        const MAX_QUESTIONS = 15;
        let gameState = {
            score: 0,
            diamonds: 0,
            difficulty: 'medium',
            missionId: 0,
            history: [],
            historyIndex: -1,
            errors: [], // Stores full question objects for retake
            isReview: false
        };

        const MUSIC = document.getElementById('bg-music');
        let musicPlaying = false;

        // --- Intro Logic ---
        function playIntro() {
            document.getElementById('start-btn-container').classList.add('hidden');
            const intro = document.getElementById('intro-animation');
            intro.classList.remove('hidden');
            
            // Play Thunder
            const thunder = document.getElementById('sfx-thunder');
            thunder.volume = 0.8;
            thunder.play().catch(e=>console.log("Audio requires interaction"));
            
            // Add Flash effect via CSS logic or just standard animation
            const flash = document.querySelector('.lightning-flash');
            flash.style.animation = "flashLightning 3s forwards";

            // End animation after 3s
            setTimeout(() => {
                document.getElementById('cinematic-overlay').classList.add('hidden');
                document.getElementById('main-interface').classList.remove('hidden');
            }, 3000);
        }

        window.toggleMusic = () => {
            if(musicPlaying) { MUSIC.pause(); document.getElementById('music-btn').textContent="ğŸµ × ×’×Ÿ"; }
            else { MUSIC.play().catch(e=>console.log(e)); document.getElementById('music-btn').textContent="ğŸ”‡ ×”×©×ª×§"; }
            musicPlaying = !musicPlaying;
        };

        window.showHome = () => { showView('intro-view'); gameState = { score: 0, diamonds: 0, difficulty: 'medium', missionId: 0, history: [], historyIndex: -1, errors: [], isReview: false }; updateUI(); };
        window.startGame = () => { if(!musicPlaying) toggleMusic(); showView('subject-menu-view'); };
        window.showView = (id) => { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); };
        window.showMathMenu = () => showView('math-menu-view');
        window.showEnglishMenu = () => showView('english-menu-view');
        window.showTips = () => document.getElementById('tips-modal').classList.remove('hidden');
        window.hideTips = () => document.getElementById('tips-modal').classList.add('hidden');
        window.showAdminPanel = () => document.getElementById('admin-panel-modal').classList.remove('hidden');
        window.hideAdminPanel = () => document.getElementById('admin-panel-modal').classList.add('hidden');

        window.loadCustomQuestions = () => {
            try {
                const newQs = JSON.parse(document.getElementById('json-input').value);
                if(!Array.isArray(newQs)) throw new Error();
                let count = 0;
                newQs.forEach(q => { if(q.missionId) { (q.missionId < 100 ? mathQ : engQ)[q.missionId]?.push(q); count++; } });
                document.getElementById('admin-feedback').innerText = `Command Executed: Loaded ${count} questions!`;
            } catch(e) { document.getElementById('admin-feedback').innerText = "Syntax Error: Invalid JSON"; }
        };
        window.clearCustomQuestions = () => { if(confirm("Are you sure you want to reset the world?")) location.reload(); };
        window.changeDifficulty = () => gameState.difficulty = document.getElementById('difficulty-select').value;
        
        window.startMission = (id) => {
            gameState.missionId = id;
            gameState.history = [];
            gameState.historyIndex = -1;
            gameState.isReview = false;
            showView('game-view');
            window.nextQ();
        };

        window.startReview = () => {
            if (gameState.errors.length === 0) return;
            const questionsToReview = [...gameState.errors];
            gameState.history = [];
            gameState.errors = []; 
            gameState.historyIndex = -1;
            gameState.isReview = true;
            
            questionsToReview.forEach(q => {
                gameState.history.push({ data: q, solved: false, tries: 0 });
            });
            showView('game-view');
            window.nextQ();
        };

        window.exitMission = () => {
            showView('summary-view');
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('final-diamonds').textContent = gameState.diamonds;
            
            const tbody = document.getElementById('error-log-body');
            tbody.innerHTML = '';
            
            if(gameState.errors.length === 0) {
                document.getElementById('no-errors-text').classList.remove('hidden');
                document.getElementById('retake-section').classList.add('hidden');
            } else {
                document.getElementById('no-errors-text').classList.add('hidden');
                document.getElementById('retake-section').classList.remove('hidden');
                
                gameState.errors.forEach(q => { 
                    let ansDisplay = q.ans || `${q.n}/${q.d}`;
                    if(q.type === 'M_WORD') ansDisplay = `${q.ansN}/${q.ansD}`;
                    tbody.innerHTML += `<tr><td>${q.q}</td><td dir="ltr" class="text-right">${ansDisplay}</td></tr>`; 
                });
            }
        };

        window.nextQ = () => {
            if(gameState.historyIndex < gameState.history.length - 1) { 
                gameState.historyIndex++; 
                renderQ(); 
            } 
            else if (gameState.isReview || gameState.history.length >= MAX_QUESTIONS) {
                exitMission();
            }
            else { 
                generateQ(); 
            }
            resetFeedback();
        };

        window.prevQ = () => { if(gameState.historyIndex > 0) { gameState.historyIndex--; renderQ(); resetFeedback(); } };
        window.skipQ = () => { 
            if(gameState.isReview) window.nextQ();
            else { generateQ(); resetFeedback(); }
        }

        function resetFeedback() {
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('check-btn').disabled = false;
            const curr = gameState.history[gameState.historyIndex];
            if(curr && curr.solved) {
                document.getElementById('check-btn').disabled = true;
                document.getElementById('feedback').innerHTML = "×›×‘×¨ × ×¤×ª×¨!";
                document.getElementById('feedback').classList.remove('hidden');
            }
        }
        function updateUI() {
            document.getElementById('score-display').textContent = gameState.score;
            document.getElementById('diamonds-display').textContent = gameState.diamonds;
            const current = gameState.historyIndex + 1;
            const total = gameState.isReview ? gameState.history.length : MAX_QUESTIONS;
            document.getElementById('q-num').textContent = `${current} / ${total}`;
            document.getElementById('mission-title').textContent = gameState.isReview ? "××‘×—×Ÿ ×—×•×–×¨ â™»ï¸" : "××©×™××”";
        }

        // --- THEMATIC QUESTION POOLS ---
        let mathQ = {
            1: [
                {q:"×‘×ª×™×‘×” ×™×© 5 ×—×¤×¦×™×. 2 ×”× ××˜×™×œ×™ ×‘×¨×–×œ (Iron Ingots). ××” ×”×©×‘×¨?", n:2, d:5, type:"M_ID", theme: "iron"},
                {q:"×‘× ×” ×©×‘×¨: 3 ××ª×•×š 4 ×™×”×œ×•××™× (Diamonds)", n:3, d:4, type:"M_ID", theme: "diamond"},
                {q:"×—×¦×™ ××”×‘×œ×•×§×™× ×”× ×¢×¥ (Oak Wood). ×‘× ×” ××ª ×”×©×‘×¨:", n:1, d:2, type:"M_ID", theme: "wood"},
                {q:"××¡×¤×ª 3 ××ª×•×š 7 ××˜×™×œ×™ ×–×”×‘ (Gold Ingots). ×™×™×¦×’ ×–××ª:", n:3, d:7, type:"M_ID", theme: "gold"},
                {q:"×”××•× ×” ×©×œ×™ 3 (Creeper heads), ×”××›× ×” 4. ××™ ×× ×™?", n:3, d:4, type:"M_ID", theme: "grass"},
                {q:"×‘× ×” ×©×‘×¨: 3 ××ª×•×š 8 ×‘×œ×•×§×™× ×©×œ TNT", n:3, d:8, type:"M_ID", theme: "tnt"}
            ],
            2: [
                {q: "×”×× 5/2 (××›×•×©×™×) ×”×•× ×©×‘×¨ ×’×“×•×œ ×-1?", ans: "improper", n:5, d:2, type:"M_SORT"},
                {q: "×”×× 10/12 (×œ×‘×‘×•×ª ×—×™×™×) ×”×•× ×©×‘×¨ ×§×˜×Ÿ ×-1?", ans: "proper", n:10, d:12, type:"M_SORT"},
                {q: "×”×× 7/7 (×©×¨×™×•×Ÿ ××œ×) × ×—×©×‘ ×’×“×•×œ/×©×•×•×” ×œ-1?", ans: "improper", n:7, d:7, type:"M_SORT"},
                {q: "××™×™×Ÿ: 4/3 ×“×œ×™×™× ×©×œ ×œ×‘×”", ans: "improper", n:4, d:3, type:"M_SORT"},
                {q: "××™×™×Ÿ: 1/4 ××¤×”", ans: "proper", n:1, d:4, type:"M_SORT"}
            ],
            3: [
                {q: "×—×™×‘×•×¨ ××©××‘×™×: 2/9 ×××¨×œ×“ + 5/9 ×××¨×œ×“ + 3/9 ×××¨×œ×“ = ?", n:10, d:9, type:"M_ID", theme: "grass"}, 
                {q: "×‘×™×©×•×œ: 3/5 ×¤×—× + 4/5 ×¤×—× = ?", n:7, d:5, type:"M_ID", theme: "stone"},
                {q: "×¡×˜×™×‘ ××›×œ 2/8 ××”×¢×•×’×”, ××œ×›×¡ ××›×œ×” 1/8. ×›××” ××›×œ×• ×™×—×“?", n:3, d:8, type:"M_ID", theme: "gold"}
            ],
            4: [
                {q: "××” ×©×•×•×” ×™×•×ª×¨? 1/7 ×™×”×œ×•× ××•×œ 1/5 ×™×”×œ×•×", n1:1, d1:7, n2:1, d2:5, ans:"<", type:"M_CMP"},
                {q: "××™ ×—×–×§ ×™×•×ª×¨? 4/3 ×—×¨×‘ ×‘×¨×–×œ ××•×œ 3/4 ×—×¨×‘ ×‘×¨×–×œ", n1:4, d1:3, n2:3, d2:4, ans:">", type:"M_CMP"},
                {q: "×”×©×•×•×” ××œ××™: 3/4 ××•×œ 3/5", n1:3, d1:4, n2:3, d2:5, ans:">", type:"M_CMP"},
                {q: "×”×©×•×•×”: 2/7 ××•×œ 4/9", n1:2, d1:7, n2:4, d2:9, ans:"<", type:"M_CMP"},
                {q: "×”×× 2/6 ×–×”×‘ ×©×•×•×” ×œ-1/3 ×–×”×‘?", n1:2, d1:6, n2:1, d2:3, ans:"=", type:"M_CMP"}
            ],
            5: [
                {q: "×‘×¡×¤×¨×™×™×” ×‘×›×¤×¨ ×™×© 3 ××“×¤×™×. ×‘×××¦×¢×™ 12 ×¡×¤×¨×™× ××›×•×©×¤×™×. ×‘×¢×œ×™×•×Ÿ 2/3 ××”×××¦×¢×™. ×›××” ×¡×¤×¨×™× ×‘×¢×œ×™×•×Ÿ?", ansN:8, ansD:1, type:"M_WORD"},
                {q: "×‘×ª×™×‘×” 20 ×‘×œ×•×§×™×. 3/10 ×”× ×¦××¨ ×™×¨×•×§ (Green Wool). ×›××” ×‘×œ×•×§×™× ×™×¨×•×§×™× ×™×©?", ansN:6, ansD:1, type:"M_WORD"},
                {q: "×‘×ª×™×‘×” 20 ×‘×œ×•×§×™×. 3/10 ×”× ×¦××¨ ×™×¨×•×§ ×•×”×©××¨ ×¦××¨ ×›×—×•×œ (Blue Wool). ×›××” ×›×—×•×œ×™×?", ansN:14, ansD:1, type:"M_WORD"},
                {q: "×¢×•×’×ª ×“×œ×¢×ª (Pumpkin Pie) ××—×•×œ×§×ª ×œ-8. ×¡×˜×™×‘ ××›×œ 2, ××œ×›×¡ ××›×œ×” 1. ×›××” × ×©××¨ ×œ×—×–×™×¨?", ansN:5, ansD:1, type:"M_WORD"}
            ]
        };

        let engQ = {
            101: [
                {q: "Craft (×œ×™×¦×•×¨)", ans: "verb", type:"E_SORT_4"},
                {q: "Twenty Diamonds", ans: "number", type:"E_SORT_4"},
                {q: "May (Month)", ans: "calendar", type:"E_SORT_4"},
                {q: "Strong (Armor)", ans: "adj", type:"E_SORT_4"},
                {q: "Thirty Creepers", ans: "number", type:"E_SORT_4"},
                {q: "Tall (Enderman)", ans: "adj", type:"E_SORT_4"},
                {q: "Climb (Ladder)", ans: "verb", type:"E_SORT_4"},
                {q: "August", ans: "calendar", type:"E_SORT_4"},
                {q: "Give (Item)", ans: "verb", type:"E_SORT_4"},
                {q: "Fast (Potion)", ans: "adj", type:"E_SORT_4"}
            ],
            102: [
                {q: "Steve ___ mining now.", ans: "is", type:"E_TOBE"},
                {q: "I ___ a builder.", ans: "am", type:"E_TOBE"},
                {q: "They ___ playing on the server.", ans: "are", type:"E_TOBE"},
                {q: "You ___ a griefer!", ans: "are", type:"E_TOBE"},
                {q: "The Zombie ___ in the cave.", ans: "is", type:"E_TOBE"},
                {q: "She ___ crafting a sword.", ans: "is", type:"E_TOBE"}
            ],
            103: [
                {q: "How old is Steve? (Text says 10)", ans: "10", type:"E_READ"},
                {q: "Steve's birthday is in which month? (June)", ans: "june", type:"E_READ"},
                {q: "What is Steve's hobby? (Building)", ans: "building", type:"E_READ"},
                {q: "Who is Steve's best friend? (Alex)", ans: "alex", type:"E_READ"},
                {q: "Alex likes to play ___.", ans: "spleef", type:"E_READ"} 
            ]
        };

        function generateQ() {
            const mId = gameState.missionId;
            let pool = (mId < 100) ? mathQ[mId] : engQ[mId];
            let qData = {};
            
            if (pool && pool.length > 0) {
                const randIndex = Math.floor(Math.random() * pool.length);
                qData = {...pool[randIndex]};
            } else {
                if (mId === 1) qData = {q: "×‘× ×” ×©×‘×¨: 1/2 (×‘×¨×™×¨×ª ××—×“×œ)", n:1, d:2, type:"M_ID", theme: "stone"};
                else qData = {q: "Ender Dragon... (×©×’×™××”)", type:"E_READ", ans:"x"};
            }

            gameState.history.push({ data: qData, solved: false, tries: 0 });
            gameState.historyIndex = gameState.history.length - 1;
            renderQ();
            updateUI();
        }

        function renderQ() {
            const q = gameState.history[gameState.historyIndex].data;
            const box = document.getElementById('game-content');
            document.getElementById('question-text').textContent = q.q;
            box.innerHTML = '';
            document.getElementById('check-btn').style.display = 'inline-block';

            if(q.type === 'M_ID' || q.type === 'M_WORD') {
                box.innerHTML = `
                    <div class="mc-slot flex flex-col items-center bg-gray-800 p-4 border-4 border-gray-600">
                        <label class="text-xs text-gray-400 mb-1">××¡×¤×¨ ×”×¤×¨×™×˜×™×</label>
                        <input id="in-n" type="number" class="mc-input w-24 mb-2" placeholder="××•× ×”">
                        <div class="fraction-divider w-24 h-1 bg-white"></div>
                        <input id="in-d" type="number" class="mc-input w-24 mt-2" placeholder="××›× ×”" value="${q.type === 'M_WORD' ? '1' : ''}">
                        <label class="text-xs text-gray-400 mt-1">×¡×š ×”×›×œ ×‘×©×•×¨×”</label>
                    </div>
                    ${q.type === 'M_ID' ? `<div id="visual-bar" class="grid-bar w-64 mt-4"></div>` : ''}
                `;
                if(q.type === 'M_ID') drawBar(q.n, q.d, q.theme || 'grass');
            } 
            else if(q.type === 'M_SORT') {
                box.innerHTML = `
                    <div class="text-5xl text-white mb-4 font-bold text-center drop-shadow-md" dir="ltr">${q.n}/${q.d}</div>
                    <div class="flex gap-4 justify-center">
                        <button onclick="check('proper')" class="btn-mc btn-stone">×§×˜×Ÿ ×-1 (Stack)</button>
                        <button onclick="check('improper')" class="btn-mc btn-stone">×’×“×•×œ/×©×•×•×” ×œ-1</button>
                    </div>
                `;
                document.getElementById('check-btn').style.display = 'none';
            }
            else if(q.type === 'M_CMP') {
                box.innerHTML = `
                    <div class="flex items-center gap-4 text-3xl font-bold">
                         <div dir="ltr" class="bg-gray-700 p-2 border-2 border-black">${q.n1}/${q.d1}</div>
                         <div class="flex flex-col gap-2">
                            <button onclick="check('<')" class="btn-mc btn-stone text-xl">&lt;</button>
                            <button onclick="check('=')" class="btn-mc btn-stone text-xl">=</button>
                            <button onclick="check('>')" class="btn-mc btn-stone text-xl">&gt;</button>
                         </div>
                         <div dir="ltr" class="bg-gray-700 p-2 border-2 border-black">${q.n2}/${q.d2}</div>
                    </div>
                `;
                document.getElementById('check-btn').style.display = 'none';
            }
            else if(q.type === 'E_SORT_4') {
                box.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <button onclick="check('verb')" class="btn-mc btn-redstone">Verb (×¤×•×¢×œ)</button>
                        <button onclick="check('adj')" class="btn-mc btn-diamond">Adjective (×ª×•××¨)</button>
                        <button onclick="check('calendar')" class="btn-mc btn-gold">Calendar (×–××Ÿ)</button>
                        <button onclick="check('number')" class="btn-mc btn-stone">Number (××¡×¤×¨)</button>
                    </div>
                `;
                document.getElementById('check-btn').style.display = 'none';
            }
            else if(q.type === 'E_TOBE') {
                box.innerHTML = `
                    <div class="flex gap-4 justify-center">
                        <button onclick="check('am')" class="btn-mc btn-wood text-xl">am</button>
                        <button onclick="check('is')" class="btn-mc btn-wood text-xl">is</button>
                        <button onclick="check('are')" class="btn-mc btn-wood text-xl">are</button>
                    </div>
                `;
                document.getElementById('check-btn').style.display = 'none';
            }
            else if(q.type === 'E_READ') {
                 box.innerHTML = `<input id="in-text" type="text" class="mc-input w-64" placeholder="×ª×©×•×‘×” ×‘×× ×’×œ×™×ª...">`;
            }
        }

        function drawBar(n, d, theme) {
            setTimeout(() => {
                const el = document.getElementById('visual-bar');
                if(!el) return;
                el.innerHTML = '';
                if (d > 20) { el.style.display = 'none'; return; } 
                el.style.display = 'flex';
                
                for(let i=0; i<d; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell' + (i<n ? ` theme-${theme}` : ' empty-cell');
                    el.appendChild(cell);
                }
            }, 0);
        }

        window.checkAnswer = check = (val) => {
            const item = gameState.history[gameState.historyIndex];
            if(item.solved) return;
            
            const q = item.data;
            let correct = false;

            if(q.type === 'M_ID' || q.type === 'M_WORD') {
                const n = parseInt(document.getElementById('in-n').value);
                const d = parseInt(document.getElementById('in-d').value);
                
                if (q.type === 'M_WORD') {
                     if (n === q.ansN && d === q.ansD) correct = true;
                     if (q.ansD === 8 && n === q.ansN && d === 1) correct = true; 
                } else {
                    correct = (n === q.n && d === q.d);
                }
            } 
            else if (q.type.includes('SORT') || q.type === 'M_CMP' || q.type === 'E_TOBE') {
                correct = (val === q.ans);
            } 
            else if (q.type === 'E_READ') {
                const t = document.getElementById('in-text').value.trim().toLowerCase();
                correct = t.includes(q.ans.toLowerCase());
            }

            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden');
            
            if(correct) {
                gameState.score += 10;
                gameState.diamonds++;
                item.solved = true;
                updateUI();
                fb.innerHTML = "× ×›×•×Ÿ ×××•×“! ğŸ’";
                fb.className = "mt-4 p-4 border-2 border-white text-center font-bold text-xl bg-green-700 text-white";
                document.getElementById('check-btn').disabled = true;
            } else {
                item.tries++;
                fb.innerHTML = "××•×¤×¡! × ×¡×” ×©×•×‘ ğŸ§Ÿ";
                fb.className = "mt-4 p-4 border-2 border-white text-center font-bold text-xl bg-red-800 text-white";
                if(item.tries === 1) gameState.errors.push(q);
            }
        };
    </script>
</body>
</html>